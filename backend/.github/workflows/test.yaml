name: Testes e Deploy - Sistema de GestÃ£o Financeira

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/'
      - 'frontend/'
      - '.github/workflows/'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/'
      - 'frontend/'

env:
  NODE_VERSION: '18'
  NPM_VERSION: '9'

jobs:
  # Job para testar o backend
  test-backend:
    name: Testes Backend
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]
    
    steps:
    - name: Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: Configurar Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: Instalar dependÃªncias do backend
      working-directory: ./backend
      run: npm ci
      
    - name: Executar testes do backend
      working-directory: ./backend
      run: npm test
      
    - name: Executar testes com cobertura
      working-directory: ./backend
      run: npm run test:coverage
      
    - name: Upload relatÃ³rio de cobertura para Codecov
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: ./backend/coverage/lcov.info
        flags: backend
        name: backend-coverage
        fail_ci_if_error: false
        verbose: true
        
    - name: Verificar qualidade do cÃ³digo
      working-directory: ./backend
      run: |
        echo "Verificando dependÃªncias desatualizadas..."
        npm outdated || true
        echo "Verificando vulnerabilidades..."
        npm audit --audit-level=moderate || true

  # Job para testar o frontend (se existir)
  test-frontend:
    name: Testes Frontend
    runs-on: ubuntu-latest
    needs: test-backend
    
    steps:
    - name: Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Verificar estrutura do frontend
      run: |
        if [ -d "frontend" ]; then
          echo "Frontend encontrado, executando verificaÃ§Ãµes..."
          cd frontend
          # Aqui vocÃª pode adicionar testes especÃ­ficos do frontend
          # npm install
          # npm test
          echo "Frontend verificado com sucesso"
        else
          echo "Frontend nÃ£o encontrado, pulando..."
        fi

  # Job para anÃ¡lise de seguranÃ§a
  security-scan:
    name: AnÃ¡lise de SeguranÃ§a
    runs-on: ubuntu-latest
    needs: test-backend
    
    steps:
    - name: Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Instalar dependÃªncias
      working-directory: ./backend
      run: npm ci
      
    - name: Executar auditoria de seguranÃ§a
      working-directory: ./backend
      run: npm audit --audit-level=high
      
    - name: Verificar dependÃªncias com vulnerabilidades conhecidas
      working-directory: ./backend
      run: |
        echo "Verificando dependÃªncias vulnerÃ¡veis..."
        npm audit --json > audit-report.json || true
        if [ -s audit-report.json ]; then
          echo "âš  Vulnerabilidades encontradas:"
          cat audit-report.json | jq -r '.vulnerabilities | keys[]' || true
        else
          echo "âœ… Nenhuma vulnerabilidade encontrada"
        fi

  # Job para build e deploy (opcional)
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: Instalar dependÃªncias
      working-directory: ./backend
      run: npm ci --only=production
      
    - name: Build do projeto
      working-directory: ./backend
      run: |
        echo "Verificando se o servidor inicia corretamente..."
        timeout 10s npm start || true
        
    - name: Deploy para produÃ§Ã£o (exemplo)
      run: |
        echo "ğŸš€ Deploy para produÃ§Ã£o iniciado..."
        echo "Aqui vocÃª pode adicionar comandos de deploy especÃ­ficos"
        echo "Exemplo: deploy para Heroku, Vercel, AWS, etc."
        
    - name: Notificar sucesso do deploy
      run: |
        echo "âœ… Deploy concluÃ­do com sucesso!"
        echo "AplicaÃ§Ã£o disponÃ­vel em: https://sua-app.herokuapp.com"

  # Job para documentaÃ§Ã£o
  documentation:
    name: Gerar DocumentaÃ§Ã£o
    runs-on: ubuntu-latest
    needs: test-backend
    
    steps:
    - name: Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Instalar dependÃªncias
      working-directory: ./backend
      run: npm ci
      
    - name: Gerar documentaÃ§Ã£o da API
      working-directory: ./backend
      run: |
        echo "ğŸ“š Gerando documentaÃ§Ã£o..."
        # Aqui vocÃª pode adicionar geraÃ§Ã£o de documentaÃ§Ã£o
        # Exemplo: jsdoc, swagger, etc.
        echo "DocumentaÃ§Ã£o gerada com sucesso"
        
    - name: Upload documentaÃ§Ã£o
      uses: actions/upload-artifact@v3
      with:
        name: documentation
        path: ./backend/docs/
        retention-days: 30

  # Job para notificaÃ§Ãµes
  notify:
    name: NotificaÃ§Ãµes
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, security-scan, deploy]
    if: always()
    
    steps:
    - name: Notificar resultado dos testes
      run: |
        if [ "${{ needs.test-backend.result }}" == "success" ]; then
          echo "âœ… Testes do backend passaram!"
        else
          echo "âŒ Testes do backend falharam!"
        fi
        
        if [ "${{ needs.test-frontend.result }}" == "success" ]; then
          echo "âœ… Testes do frontend passaram!"
        else
          echo "âŒ Testes do frontend falharam!"
        fi
        
        if [ "${{ needs.security-scan.result }}" == "success" ]; then
          echo "âœ… AnÃ¡lise de seguranÃ§a passou!"
        else
          echo "âŒ AnÃ¡lise de seguranÃ§a falhou!"
        fi
        
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… Deploy realizado com sucesso!"
        elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
          echo "â­ Deploy pulado (nÃ£o Ã© branch main)"
        else
          echo "âŒ Deploy falhou!"
Â Â Â Â Â Â Â Â fi